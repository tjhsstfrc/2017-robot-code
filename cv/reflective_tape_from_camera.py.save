import numpy as np
import cv2
from pyimagesearch.shapedetector import ShapeDetector
import imutils
import time
from networktables import NetworkTable as NT
import logging

logging.basicConfig(level=logging.DEBUG)


ip = 'roborio-3455-frc.local'

NT.setIPAddress('10.34.55.96')
NT.setClientMode()
NT.initialize()

table = NT.getTable("SmartDashboard")

#allow connection
time.sleep(3)

cap = cv2.VideoCapture(0)

while(True):
    # Capture frame-by-frame
    ret, frame = cap.read()
    hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
    
    #TEMP VALUES
    lower_blue = np.array([80,60,250])#80 60 250
    upper_blue = np.array([100,250,255])#100 250 255
    

    # Threshold the HSV image to get only blue colors
    mask = cv2.inRange(hsv, lower_blue, upper_blue)
    # Bitwise-AND mask and original image
    res = cv2.bitwise_and(frame, frame, mask=mask)
   
    #Noise
    kernel = np.ones((5,5),np.uint8)
    erosion = cv2.erode(mask,kernel,iterations = 1)

    kernel = np.ones((10,10), np.uint8)
    dilation = cv2.dilate(erosion, kernel, iterations = 3)
    dilation = cv2.erode(dilation, kernel, iterations = 1)
    # Display the resulting frame
   
    cv2.imshow('res',res)
    cv2.imshow('Noise Reduction',dilation)    
    cv2.imshow('frame',frame)
    
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

    
    cnts = cv2.findContours(dilation.copy(), cv2.RETR_EXTERNAL,
    cv2.CHAIN_APPROX_SIMPLE)
    cnts = cnts[0] if imutils.is_cv2() else cnts[1]
    sd = ShapeDetector()

    arr = []
    for c in cnts:
        arr.append((cv2.contourArea(c), c))
    cX, cY = 0, 0
    if(len(arr) > 0):
        c = (arr[-1::-1][0][1])
    
        # loop over the contours
        # compute the center of the contour, then detect the name of the
        # shape using only the contour
        M = cv2.moments(c)
        cX = int((M["m10"] / M["m00"]))
        cY = int((M["m01"] / M["m00"]))
        shape = sd.detect(c)

        

        # multiply the contour (x, y)-coordinates by the resize ratio,
        # then draw the contours and the name of the shape on the image
        c = c.astype("float")
        c = c.astype("int")
        cv2.drawContours(frame, [c], -1, (0, 255, 0), 2)
        cv2.putText(frame, shape, (cX, cY), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 255), 2)
        cv2.circle(frame, (cX, cY), 5, (0,0,255), -1)
     # show the output image
    cv2.imshow("Image", frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break
    
    #Get Center of Imagee
    height, width, channels = frame.shape
    goalX = width/2.0
    goalY = height/2.0
    #Turning (Set x)
    if  goalX - cX > 5 or goalX - cX < -5:
        turning = True #send
        table.putBoolean('Turning', turning)
        error = goalX - cX
        pConst = 1.0/goalX
        turnSpeed = pConst*error #send
        table.putNumber('Turning Value', turnSpeed)
   
    #Back/Forth
    if  goalY - cY > 5 or goalY - cY < -5:
        turning = False #send
        table.putBoolean('Turning', turning)
        error = goalY - cY
        pConst = -1.0/goalY
        linearSpeed = pConst*error #send
        table.putNumber('Linear  Value', linearSpeed)
    
   
# When everything done, release the capture
cap.release()
cv2.destroyAllWindows()
